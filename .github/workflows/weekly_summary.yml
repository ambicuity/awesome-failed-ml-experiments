# =============================================================================
# Weekly Summary Workflow
# =============================================================================
#
# This workflow generates a weekly summary of:
# - New submissions from the past week
# - Common failure patterns
# - Statistics and trends
# - Top contributors
#
# Schedule: Every Sunday at 03:00 UTC
#
# Author: Ritesh Rana (riteshrana36@gmail.com)
# =============================================================================

name: Weekly Summary

on:
  # Run every Sunday at 03:00 UTC
  schedule:
    - cron: '0 3 * * 0'

  # Allow manual trigger for testing
  workflow_dispatch:

# Permissions needed for committing
permissions:
  contents: write
  issues: write

jobs:
  generate-summary:
    name: Generate Weekly Summary
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Setup
      # -----------------------------------------------------------------------

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------------------------
      # Generate Summary
      # -----------------------------------------------------------------------

      - name: ðŸ“Š Generate weekly summary
        run: |
          echo "Generating weekly summary..."
          python scripts/weekly_summary.py

      - name: ðŸ“ Update README
        run: |
          echo "Updating README..."
          python scripts/update_readme.py

      # -----------------------------------------------------------------------
      # Commit and Push
      # -----------------------------------------------------------------------

      - name: ðŸ’¾ Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Stage changes
          git add WEEKLY_SUMMARY.md README.md

          # Create commit with date in message
          WEEK_DATE=$(date +"%Y-%m-%d")
          git commit -m "ðŸ“Š Weekly summary for $WEEK_DATE" \
                     -m "Auto-generated weekly summary of ML experiment failures."

          # Push changes
          git push origin main

      # -----------------------------------------------------------------------
      # Create Discussion Issue (Optional)
      # -----------------------------------------------------------------------

      - name: ðŸ’¬ Create discussion issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - 7);

            const formatDate = (d) => d.toISOString().split('T')[0];

            const title = `ðŸ“Š Weekly Digest: ${formatDate(weekStart)} - ${formatDate(today)}`;

            const body = `# Weekly Digest ðŸ“Š

            A new weekly summary has been generated!

            ## ðŸ“… Week of ${formatDate(weekStart)} - ${formatDate(today)}

            Check out [WEEKLY_SUMMARY.md](WEEKLY_SUMMARY.md) for the full report including:

            - ðŸ†• New submissions
            - ðŸ·ï¸ Common failure patterns
            - ðŸ“ˆ Statistics and trends
            - ðŸ† Top contributors

            ## ðŸ’¬ Discussion

            What patterns did you notice this week? Any lessons that stood out?

            Share your thoughts below! ðŸ‘‡

            ---

            _This issue was created automatically by the weekly summary workflow._
            `;

            // Check if a similar issue already exists this week
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'weekly-digest',
              per_page: 10,
            });

            const recentDigest = issues.find(issue =>
              issue.title.includes(formatDate(today))
            );

            if (recentDigest) {
              console.log('Weekly digest issue already exists');
              return;
            }

            // Create the issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['weekly-digest', 'automated'],
            });

            console.log('Created weekly digest issue');

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------

      - name: ðŸ“Š Workflow Summary
        if: always()
        run: |
          echo "========================================"
          echo "    WEEKLY SUMMARY COMPLETE"
          echo "========================================"
          echo "Generated: $(date)"
          echo "========================================"
